image: debian/stable
sources:
- https://git.sr.ht/~singpolyma/cheogram-android
artifacts:
- cheogram.apk
- cheogram_google_play.apk
packages:
- wget
- unzip
- android-sdk
secrets:
- 7eed327c-05c7-49b4-baed-a4d8785588d5
- 9c6cc176-db6c-4158-9abb-2cb1662d5ca9
environment:
  ANDROID_SDK_ROOT: /home/build/android
tasks:
- sdk: |
    wget -qO android.zip https://dl.google.com/android/repository/commandlinetools-linux-6987402_latest.zip
    unzip -qq android.zip
    mkdir -p android/cmdline-tools
    mv cmdline-tools android/cmdline-tools/tools
    echo y | android/cmdline-tools/tools/bin/sdkmanager "platforms;android-29"
    echo y | android/cmdline-tools/tools/bin/sdkmanager "platform-tools"
    echo y | android/cmdline-tools/tools/bin/sdkmanager "build-tools;29.0.2"
    touch ~/.android/repositories.cfg
    yes | android/cmdline-tools/tools/bin/sdkmanager --licenses
- sentry: |
    cd cheogram-android
    sed -ie 's/<!-- INSERT -->/<meta-data android:name="io.sentry.dsn" android:value="https:\/\/680d470d348a4cc494bf2198eed30c49@o559641.ingest.sentry.io\/6221823" \/>/' src/cheogram/AndroidManifest.xml
    sed -ie 's/\/\/ INSERT/implementation "io.sentry:sentry-android:6.4.2"/' build.gradle
- build_free: |
    cd cheogram-android
    ./gradlew assembleCheogramFreeDebug
- build_google_play: |
    cd cheogram-android
    mkdir -p src/playstore/res/values/
    mv ~/push.xml src/playstore/res/values/
    ./gradlew assembleCheogramPlaystoreDebug
- assets: |
    mv cheogram-android/build/outputs/apk/cheogramFree/debug/*.apk cheogram.apk
    mv cheogram-android/build/outputs/apk/cheogramPlaystore/debug/*.apk cheogram_google_play.apk
